<!DOCTYPE html>
<html lang="en">
<head>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
      table {
            width: 100%;
            border-collapse: collapse;
            font-family: Arial, sans-serif;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            height: 50px;
            position: relative;
        }

        td.editable {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            max-height: 50px;
            padding: 5px;
            line-height: 1.2;
        }

        td.editable:focus {
            outline: 2px solid #007bff;
            background-color: #fff;
            height: auto;
            max-height: 150px;
            z-index: 1;
            position: relative;
        }

        th {
            background-color: #f4f4f4;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 2;
        }

#projectTable th:nth-child(1), 
#projectTable td:nth-child(1) {
    width: 60px; /* Adjust width for Sr. No */
}

#projectTable th:nth-child(2), 
#projectTable td:nth-child(2) {
    width: 90px; /* Adjust width for Date */
}

#projectTable th:nth-child(7), 
#projectTable td:nth-child(7) {
    width: 100px; /* Adjust width for Date */
}

#projectTable th:nth-child(8), 
#projectTable td:nth-child(8) {
    width: 260px; /* Adjust width for Date */
}


#projectTable th:nth-child(9), 
#projectTable td:nth-child(9) {
    width: 120px; /* Adjust width for Date */
}

    #projectTable td:nth-child(3), /* Project Name */
    #projectTable td:nth-child(4), /* Subject */
    #projectTable td:nth-child(5), /* Sent To */
    #projectTable td:nth-child(6)  /* Sent By */
    {
        width: 150px; /* Set the width for these editable columns */
    }
    

    .editable {
        overflow-wrap: break-word;
        white-space: normal; /* Allow wrapping */
        height: 50px; /* Fixed height */
        cursor: text;
        max-width: 150px; /* Set a max-width */
        padding: 5px; /* Add padding for aesthetics */
        overflow-y:hidden; /* Enable scrolling if content exceeds height */
        }

.editable:focus {
    outline: 2px solid #007bff;
    background-color: #fff;
}

tr:nth-child(even) {
    background-color: #f8f8f8;
}

.editable:hover {
    background-color: #f0f0f0;
}

.add-btn, .delete-btn, .save-btn {
    font-weight: bold;
    color: black;
    padding: 10px 9px;
    cursor: pointer;
    border: none;
    border-radius: 4px;
}

.add-btn {
    background-color: lightgreen;
}

.add-btn:hover {
    background-color: rgb(36, 46, 189);
    color: #ddd; /* Change color for contrast */
}

.delete-btn {
    background-color: lightcoral;
}

.delete-btn:hover {
    background-color: #ff2147;
    color: #fff; /* Change color for contrast */
}

.save-btn {
    background-color: darksalmon;
}

.save-btn:hover {
    background-color: #ff8c8c; /* Change hover color */
    color: #fff; /* Change color for contrast */
}

#tableContainer {
    height: 680px;
    overflow-y: auto;
}

.cell-focus {
            outline: 2px solid #007bff !important;
            background-color: #f0f8ff !important;
        }
        
        /* Make select elements fill their container */
        select {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            padding: 5px;
            cursor: pointer;
        }

        /* Style for select elements when their cell has focus */
        td.cell-focus select {
            outline: none;
            background-color: #f0f8ff;
        }

        select:focus {
            outline: 2px solid #007bff;
        }
    </style>
</head>

<body>

    <button class="add-btn" onclick="addRow()"> 
        Add New Row ‚ûï
    </button>
    <button class="save-btn" onclick="saveAllRows()"> 
        Saving... üíæ
    </button>
    
    <button class="delete-btn" onclick="deleteAllRows()"> 
        Delete All Rows ‚ùå
    </button>


    <div id="tableContainer">
        <table id="projectTable">
            <thead>
                <tr>
                    <th>Sr. No</th>
                    <th>Date</th>
                    <th>Project Name</th>
                    <th class="subject-cell">Subject</th>
                    <th>Sent To</th>
                    <th>Sent By</th>
                    <th>Mode By</th>
                    <th>Letter No</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyALwHPP263lThq0dpSgjzquqWcork4bOJ4",
            authDomain: "connectdb1.firebaseapp.com",
            projectId: "connectdb1",
            storageBucket: "connectdb1.appspot.com",
            messagingSenderId: "1578684614",
            appId: "1:1578684614:web:e5766803dd0fc7ca9a87c7",
            measurementId: "G-FV3VRFHQGV"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const projectsCollection = db.collection('projects');
        let isLoading = false;


        async function checkScroll() {
            const container = document.getElementById('tableContainer');
            if (container.scrollTop + container.clientHeight >= container.scrollHeight - 10 && !isLoading) {
                isLoading = true;
                await addInitialRows(15); // Increase to 15 rows on scroll
                isLoading = false;
            }
        }

        async function addInitialRows(count) {
            for (let i = 0; i < count; i++) {
                await addRow();
            }
        }

        async function addRow(rowData = null) {
            const tbody = document.querySelector('#projectTable tbody');
            const newRow = document.createElement('tr');
            const rowId = rowData ? rowData.id : Date.now().toString();
            newRow.setAttribute('data-id', rowId);
            const columns = 8; // Total number of columns except for actions

            for (let i = 0; i < columns; i++) {
                const cell = document.createElement('td');
                cell.className = 'editable';

                switch (i) {
                    case 0:
                        cell.textContent = tbody.children.length + 1;
                        cell.style.textAlign='center';
                        cell.style.width='10px';
                        cell.contentEditable = false;
                        break;
                    case 1:
                        cell.textContent = rowData ? rowData.date : getCurrentDate(); // Date
                        cell.style.textAlign='center'; 
                        cell.contentEditable = false;
                        break;
                    case 6:
                        const select = createModeBySelect(); // Mode By
                        if (rowData) {
                            select.value = rowData.modeBy;
                        }
                        cell.appendChild(select);
                        cell.contentEditable = false;
                        break;
                    case 7:
                        cell.textContent = rowData ? rowData.letterNo : getLetterNumber(tbody.children.length + 1); // Letter No
                        cell.contentEditable = false;
                        break;
                    case 3:
                        cell.contentEditable = true; // Subject
                        if (rowData) {
                            cell.textContent = rowData.subject || '';
                        }
                        break;
                    default:
                        cell.contentEditable = true; // Other editable fields
                        if (rowData) {
                            const fields = ['srNo', 'date', 'projectName', 'subject', 'sentTo', 'sentBy', 'modeBy', 'letterNo'];
                            cell.textContent = rowData[fields[i]] || '';
                        }
                }
                newRow.appendChild(cell);
            }

            const deleteCell = document.createElement('td');
            deleteCell.style.textAlign='center';
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete üóëÔ∏è';
            deleteBtn.className = 'delete-btn';
            deleteBtn.onclick = async function() {
                if (confirm('Are you sure you want to delete this row?')) {
                    const rowId = newRow.getAttribute('data-id');
                    await deleteRowFromFirebase(rowId);
                    newRow.remove();
                }
            };
            deleteCell.appendChild(deleteBtn);
            newRow.appendChild(deleteCell);
            tbody.appendChild(newRow);

            if (!rowData) {
                await saveRowToFirebase(newRow);
            }
            newRow.cells[0].focus(); // Focus the first cell of the new row
        }
       

        function createModeBySelect() {
            const select = document.createElement('select');
            const options = ['By Hand', 'By Email', 'By Courier'];
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            return select;
        }

        async function saveRowToFirebase(row) {
            const rowId = row.getAttribute('data-id');
            const rowData = {
                srNo: row.cells[0].textContent,
                date: row.cells[1].textContent,
                projectName: row.cells[2].textContent,
                subject: row.cells[3].textContent,
                sentTo: row.cells[4].textContent,
                sentBy: row.cells[5].textContent,
                modeBy: row.cells[6].querySelector('select').value,
                letterNo: row.cells[7].textContent,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await projectsCollection.doc(rowId).set(rowData);
            } catch (error) {
                console.error("Error saving to Firebase:", error);
                alert("Error saving data. Please try again.");
            }
        }

        async function deleteRowFromFirebase(rowId) {
            try {
                await projectsCollection.doc(rowId).delete();
            } catch (error) {
                console.error("Error deleting from Firebase:", error);
                alert("Error deleting data. Please try again.");
            }
        }

        async function loadDataFromFirebase() {
            try {
                const snapshot = await projectsCollection.orderBy('timestamp').get();
                const tableBody = document.querySelector('#projectTable tbody');
                tableBody.innerHTML = ''; // Clear existing rows
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    addRow({ id: doc.id, ...data });
                });
            } catch (error) {
                console.error("Error loading data from Firebase:", error);
                alert("Error loading data. Please refresh the page.");
            }
        }

        async function deleteAllRows() {
            const tbody = document.querySelector('#projectTable tbody');
            const rows = Array.from(tbody.children); // Convert HTMLCollection to array
            const rowIds = rows.map(row => row.getAttribute('data-id')); // Get all row IDs

            for (const rowId of rowIds) {
                await deleteRowFromFirebase(rowId);
            }

            tbody.innerHTML = ''; // Clear the table body
        }

        function getCurrentDate() {
            const date = new Date();
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const yy = date.getFullYear().toString().slice(-2);
            return `${dd}-${mm}-${yy}`;
        }

        function getLetterNumber(serialNumber) {
            const date = new Date();
            const month = date.getMonth() + 1; // Month is zero-based, so add 1
            const monthStr = String(month).padStart(2, '0'); // Format as two-digit string
            const year = date.getFullYear();
            const fiscalYear = `${year}-${(year + 1).toString().slice(-2)}`;
            return `CEINSYS/OPR/${fiscalYear}/${monthStr}/${String(serialNumber).padStart(4, '0')}`;
        }
        function highlightSelected() {
        const selectedCell = document.querySelector('.editable:focus');
        if (selectedCell) {
        selectedCell.classList.toggle('highlighted');
        } else {
        alert("Please select a cell to highlight.");
        }
        }

        function strikeThroughSelected() {
         const selectedCell = document.querySelector('.editable:focus');
        if (selectedCell) {
        selectedCell.classList.toggle('strike-through');
        } else {
        alert("Please select a cell to strike through.");
        }
        }
        function handleKeyNavigation(e, element) {
            const row = element.closest('tr');
            const cells = Array.from(row.cells);
            const currentIndex = cells.indexOf(element);
            
            switch(e.key) {
                case 'ArrowRight':
                    if (currentIndex < cells.length - 1) {
                        const nextCell = cells[currentIndex + 1];
                        if (nextCell.querySelector('select')) {
                            nextCell.querySelector('select').focus();
                        } else {
                            nextCell.focus();
                        }
                        e.preventDefault();
                    }
                    break;
                    
                case 'ArrowLeft':
                    if (currentIndex > 0) {
                        const prevCell = cells[currentIndex - 1];
                        if (prevCell.querySelector('select')) {
                            prevCell.querySelector('select').focus();
                        } else {
                            prevCell.focus();
                        }
                        e.preventDefault();
                    }
                    break;
                    
                case 'ArrowDown':
                    const nextRow = row.nextElementSibling;
                    if (nextRow) {
                        const targetCell = nextRow.cells[currentIndex];
                        if (targetCell.querySelector('select')) {
                            targetCell.querySelector('select').focus();
                        } else {
                            targetCell.focus();
                        }
                    }
                    e.preventDefault();
                    break;
                    
                case 'ArrowUp':
                    const prevRow = row.previousElementSibling;
                    if (prevRow) {
                        const targetCell = prevRow.cells[currentIndex];
                        if (targetCell.querySelector('select')) {
                            targetCell.querySelector('select').focus();
                        } else {
                            targetCell.focus();
                        }
                    }
                    e.preventDefault();
                    break;
            }
        }

        document.addEventListener('keydown', function(e) {
            const target = e.target;
            if (target.matches('.editable') || target.matches('select')) {
                handleKeyNavigation(e, target.matches('select') ? target.parentElement : target);
            }
        });

        function createModeBySelect() {
            const select = document.createElement('select');
            const options = ['By Hand', 'By Email', 'By Courier'];
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            select.addEventListener('change', function() {
                const row = this.closest('tr');
                saveRowToFirebase(row);
            });
            return select;
        }
        function handleTableNavigation(e) {
            const target = e.target;
            const cell = target.closest('td');
            if (!cell) return;
            
            const row = cell.closest('tr');
            const tbody = row.closest('tbody');
            const currentRowIndex = Array.from(tbody.rows).indexOf(row);
            const currentCellIndex = Array.from(row.cells).indexOf(cell);

            let nextCell = null;
            let handled = true;

            switch (e.key) {
                case 'ArrowRight':
                    if (currentCellIndex < row.cells.length - 1) {
                        nextCell = row.cells[currentCellIndex + 1];
                    }
                    break;

                case 'ArrowLeft':
                    if (currentCellIndex > 0) {
                        nextCell = row.cells[currentCellIndex - 1];
                    }
                    break;

                case 'ArrowDown':
                    if (currentRowIndex < tbody.rows.length - 1) {
                        nextCell = tbody.rows[currentRowIndex + 1].cells[currentCellIndex];
                    } else {
                        // Add new row when at the bottom
                        addRow().then(() => {
                            const newRow = tbody.rows[tbody.rows.length - 1];
                            nextCell = newRow.cells[currentCellIndex];
                            focusCell(nextCell);
                        });
                        return;
                    }
                    break;

                case 'ArrowUp':
                    if (currentRowIndex > 0) {
                        nextCell = tbody.rows[currentRowIndex - 1].cells[currentCellIndex];
                    }
                    break;

                case 'Enter':
                    if (cell.contentEditable === 'true') {
                        // Move to next row on Enter if we're in an editable cell
                        if (currentRowIndex < tbody.rows.length - 1) {
                            nextCell = tbody.rows[currentRowIndex + 1].cells[currentCellIndex];
                        } else {
                            addRow().then(() => {
                                const newRow = tbody.rows[tbody.rows.length - 1];
                                nextCell = newRow.cells[currentCellIndex];
                                focusCell(nextCell);
                            });
                            return;
                        }
                    }
                    break;

                case 'Tab':
                    // Handle tab navigation
                    if (!e.shiftKey && currentCellIndex < row.cells.length - 1) {
                        nextCell = row.cells[currentCellIndex + 1];
                    } else if (e.shiftKey && currentCellIndex > 0) {
                        nextCell = row.cells[currentCellIndex - 1];
                    }
                    break;

                default:
                    handled = false;
            }

            if (nextCell && handled) {
                e.preventDefault();
                focusCell(nextCell);
            }
        }

        // Helper function to focus and highlight a cell
        function focusCell(cell) {
            // Remove focus class from all cells
            document.querySelectorAll('td').forEach(td => td.classList.remove('cell-focus'));
            
            // Add focus class to target cell
            cell.classList.add('cell-focus');

            // Handle different types of cells
            const select = cell.querySelector('select');
            if (select) {
                select.focus();
            } else if (cell.contentEditable === 'true') {
                cell.focus();
            } else {
                cell.setAttribute('tabindex', '0');
                cell.focus();
            }
        }

        // Add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const table = document.getElementById('projectTable');
            
            // Handle keyboard navigation
            table.addEventListener('keydown', handleTableNavigation);

            // Handle cell clicks
            table.addEventListener('click', function(e) {
                const cell = e.target.closest('td');
                if (cell) {
                    focusCell(cell);
                }
            });

            // Save on blur
            table.addEventListener('blur', function(e) {
                const cell = e.target.closest('td');
                if (cell && cell.contentEditable === 'true') {
                    const row = cell.closest('tr');
                    saveRowToFirebase(row);
                }
            }, true);

            // Initialize first cell focus
            const firstCell = table.querySelector('tbody tr:first-child td:first-child');
            if (firstCell) {
                focusCell(firstCell);
            }
        });

        // Modify createModeBySelect to work with new focus system
        function createModeBySelect() {
            const select = document.createElement('select');
            const options = ['By Hand', 'By Email', 'By Courier'];
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            
            select.addEventListener('change', function() {
                const row = this.closest('tr');
                saveRowToFirebase(row);
            });

            return select;
        }


        document.getElementById('projectTable').addEventListener('keydown', async function(e) {
            const target = e.target;
            if (target.matches('.editable')) {
                const row = target.closest('tr');
                const cells = Array.from(row.cells);
                const index = cells.indexOf(target);

                // Navigate with arrow keys
                if (e.key === 'ArrowRight' && index < cells.length - 1) {
                    cells[index + 1].focus();
                    e.preventDefault();
                } else if (e.key === 'ArrowLeft' && index > 0) {
                    cells[index - 1].focus();
                    e.preventDefault();
                } else if (e.key === 'ArrowDown') {
                    const nextRow = row.nextElementSibling;
                    if (nextRow) {
                        nextRow.cells[index].focus();
                    } else {
                        await addRow(); // Add a new row if at the last row
                    }
                    e.preventDefault();
                } else if (e.key === 'ArrowUp') {
                    const prevRow = row.previousElementSibling;
                    if (prevRow) {
                        prevRow.cells[index].focus();
                    }
                    e.preventDefault();
                }

                // Enter key to edit
                if (e.key === 'Enter') {
                    target.contentEditable = true;
                    e.preventDefault();
                }
            }
        });
        
        window.addEventListener('load', async () => {
            await loadDataFromFirebase();
            await addInitialRows(15); // Load initial rows
        });

    </script>
</body>
</html>
